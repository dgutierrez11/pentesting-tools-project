import psycopg2
from config import config

class ConnectionPostgres:
    connection = None

    def __init_(self):
        pass

    def conectar(self):

        # read connection parameters
        params = config()

        self.connection = psycopg2.connect(**params)

        # Print PostgreSQL Connection properties
        print(self.connection.get_dsn_parameters(), "\n")

    def ejecutarconsulta(self):
        try:
            self.conectar()
            if self.connection:
                cursor = self.connection.cursor()
                # Print PostgreSQL version
                cursor.execute("SELECT version();")
                record = cursor.fetchone()
                print("You are connected to - ", record, "\n")
        except (Exception, psycopg2.Error) as error:
            print("Error while connecting to PostgreSQL", error)
        finally:
            # closing database connection.
            if (self.connection):
                cursor.close()
                self.connection.close()
                print("PostgreSQL connection is closed")

    def execute_query(self, query):
        try:
            self.conectar()
            if self.connection:
                cursor = self.connection.cursor()
                # Print PostgreSQL version
                cursor.execute(query)
                record = cursor.fetchall()
                print("You are connected to - ", record, "\n")
        except (Exception, psycopg2.Error) as error:
            print("Error while connecting to PostgreSQL", error)
        finally:
            # closing database connection.
            if self.connection:
                cursor.close()
                self.connection.close()
                print("PostgreSQL connection is closed")

    def add_record(self, parameters):
        try:
            self.conectar()
            if self.connection:
                cursor = self.connection.cursor()
                cursor.execute("""
                                INSERT INTO alert(caseId, name, type, risk, description, cwe, dateCreated)  
                                VALUES (%s, %s, %s, %s, %s, %s, %s)
                               """, parameters)
                self.connection.commit()
        except (Exception, psycopg2.Error) as error:
            print("Error guardando registro ", error)
        finally:
            # closing database connection.
            if self.connection:
                cursor.close()
                self.connection.close()
                print("PostgreSQL connection is closed")

    def add_all_record(self, list_records):
        sql = """
        INSERT INTO alert(caseId, name, type, risk, description, cwe, dateCreated) 
        VALUES (%s, %s, %s, %s, %s, %s, %s)
        """
        try:
            self.conectar()
            if self.connection:
                cursor = self.connection.cursor()
                cursor.executemany(sql, list_records)
                self.connection.commit()
        except (Exception, psycopg2.Error) as error:
            print("Error guardando registro ", error)
        finally:
            # closing database connection.
            if self.connection:
                cursor.close()
                self.connection.close()
                print("PostgreSQL connection is closed")
